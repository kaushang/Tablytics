let y=null,b=null,u={},w=null,h={},g={},D=new Set,m=!0,S=null,p=!1,c=Date.now(),f=[],n={},I=0,l=null;const T=()=>{const t=new Date;return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`};function $(){chrome.storage.session.get(["sessionId","sessionStartTime"],t=>{t.sessionId&&t.sessionStartTime?(l=t.sessionStartTime,console.log("Retrieved existing session:",t.sessionId,"started at",new Date(l))):L()})}function L(){const t=Date.now(),s=`session_${t}`;return chrome.storage.session.set({sessionStartTime:t,sessionId:s}),l=t,chrome.storage.local.set({lastSessionId:s}),console.log("New session started:",s,"at",new Date(t)),s}chrome.storage.local.get(["tabData","activeDomain","timeLimits","strictLimits","isTrackingEnabled","dailyTabData"],t=>{t.tabData&&(u=t.tabData),t.activeDomain&&(w=t.activeDomain),t.timeLimits&&(h=t.timeLimits),t.strictLimits&&(g=t.strictLimits),t.isTrackingEnabled!==void 0&&(m=t.isTrackingEnabled),t.dailyTabData&&(n=t.dailyTabData);const s=T();n[s]||(n[s]={tabData:{},websitesVisited:[],totalTime:0},chrome.storage.local.set({dailyTabData:n})),$(),o(),v(),A()});function W(t,s){const r=T();n[r]||(n[r]={tabData:{},websitesVisited:[],totalTime:0});const i=n[r];i.tabData[t]||(i.tabData[t]=0),i.tabData[t]+=s,i.websitesVisited.includes(t)||i.websitesVisited.push(t),i.totalTime=Object.values(i.tabData).reduce((e,a)=>e+a,0),chrome.storage.local.set({dailyTabData:n})}async function o(){if(m)try{I=Date.now();let s=[];const r=await chrome.windows.getAll({populate:!0});for(const i of r){const e=i.tabs.find(a=>a.active);if(e&&k(e)&&(s.push(e),i.focused&&(y=e.id,b=Date.now(),c=Date.now(),e.url)))try{e.url.startsWith("chrome://")||e.url.startsWith("chrome-extension://")||e.url.startsWith("about:")||e.url.startsWith("edge://")?w=e.url.split("/").slice(0,3).join("/").replace(/\/$/,""):w=new URL(e.url).hostname,w||(w="New Tab"),chrome.storage.local.set({activeDomain:w})}catch(a){console.log("Error setting active domain:",a)}}f=s.filter(i=>{try{return i.url}catch{return!1}}),f.length>0&&!l&&L(),console.log(`Tracking ${f.length} active tabs across ${new Set(f.map(i=>i.windowId)).size} windows`)}catch(t){console.log("Error checking active tabs:",t)}}function k(t){try{return t&&t.url&&t.status==="complete"}catch{return!1}}const U=async(t,s)=>{if(h[t]&&s>=h[t])if(g[t]){if(!D.has(t)){console.log(`Strict time limit reached for ${t}. Closing tabs...`),D.add(t);const r=await chrome.tabs.query({});let i=0;for(const e of r)try{let a;e.url&&(e.url.startsWith("chrome://")||e.url.startsWith("chrome-extension://")||e.url.startsWith("about:")||e.url.startsWith("edge://")?a=e.url.split("/").slice(0,3).join("/").replace(/\/$/,""):a=new URL(e.url).hostname,a||(a="New Tab"),a===t&&(await chrome.tabs.remove(e.id),i++))}catch(a){console.log("Error processing tab for strict limit:",a)}i>0&&chrome.notifications.create({type:"basic",iconUrl:"icons/icon128.png",title:"Strict Time Limit Enforced",message:`Reached limit of ${E(h[t])} on ${t}. ${i} tab(s) have been closed.`}),setTimeout(()=>{D.delete(t)},3e5)}}else D.has(t)||(chrome.notifications.create({type:"basic",iconUrl:"icons/icon128.png",title:"Time Limit Reached",message:`You've spent ${E(s)} on ${t}. Your limit was ${E(h[t])}.`}),D.add(t),setTimeout(()=>{D.delete(t)},36e5))},E=t=>{const s=Math.floor(t/1e3),r=Math.floor(s/60),i=Math.floor(r/60);return i>0?`${i}h ${r%60}m`:`${r}m ${s%60}s`};async function v(){try{const t=await chrome.tabs.query({}),s=new Set;for(const a of t)try{if(a.url){let d;a.url.startsWith("chrome://")||a.url.startsWith("chrome-extension://")||a.url.startsWith("about:")||a.url.startsWith("edge://")?d=a.url.split("/").slice(0,3).join("/").replace(/\/$/,""):d=new URL(a.url).hostname,d||(d="New Tab"),s.add(d)}}catch(d){console.log("Error processing tab URL:",d)}const r=T();let i=!1;const e={};for(const[a,d]of Object.entries(u))s.has(a)?e[a]=d:i=!0;i&&(u=e,chrome.storage.local.set({tabData:u}),console.log("Removed closed tabs from tracking data"))}catch(t){console.log("Error cleaning up closed tabs:",t)}}async function C(){if(!(p||!m)){p=!0;try{if(Date.now()-I>5e3&&await o(),f.length===0){p=!1;return}const s=Date.now(),r=1e3,i=r/f.length;for(const e of f)try{if(e.url){let a;e.url.startsWith("chrome://")||e.url.startsWith("chrome-extension://")||e.url.startsWith("about:")||e.url.startsWith("edge://")?a=e.url.split("/").slice(0,3).join("/").replace(/\/$/,""):a=new URL(e.url).hostname,a||(a="New Tab"),u[a]||(u[a]=0),u[a]+=r,W(a,i),await U(a,u[a])}}catch(a){console.log("Error processing tab in tracking:",a)}await chrome.storage.local.set({tabData:u}),b=s,c=s}catch(t){console.log("Error in tab tracking update:",t)}finally{p=!1}}}function A(){S&&clearInterval(S),S=setInterval(async()=>{await C()},1e3),setInterval(async()=>{Date.now()-c>5e3&&(console.log("Heartbeat check - no recent updates, refreshing active tabs"),await o())},1e4)}chrome.tabs.onActivated.addListener(async t=>{console.log("Tab activated:",t),y=t.tabId,b=Date.now(),c=Date.now(),l||L(),await o()});chrome.tabs.onUpdated.addListener(async(t,s,r)=>{m&&(s.url&&(console.log("Tab URL changed:",t,s.url),c=Date.now(),await o()),s.status==="complete"&&await o(),c=Date.now())});chrome.tabs.onCreated.addListener(async t=>{m&&(console.log("New tab created:",t.id),c=Date.now(),await o())});chrome.tabs.onRemoved.addListener(async t=>{t===y&&(y=null,b=null,await o());const s=f.findIndex(r=>r.id===t);s>=0&&f.splice(s,1),setTimeout(async()=>{await v(),await o()},500)});chrome.windows.onFocusChanged.addListener(async t=>{t!==chrome.windows.WINDOW_ID_NONE&&(c=Date.now(),await o())});chrome.windows.onCreated.addListener(async t=>{c=Date.now(),await o()});chrome.runtime.onMessage.addListener((t,s,r)=>{if(t.type==="USER_ACTIVITY")return c=Date.now(),r({success:!0}),!0;if(t.type==="GET_TAB_DATA"){if(t.forceRefresh)o().then(()=>{v().then(()=>{const i=T(),e=n[i]||{websitesVisited:[],totalTime:0};r({tabData:u,activeDomain:w,timeLimits:h,strictLimits:g,activeTabs:f,dailyData:e,sessionStartTime:l,currentSessionTime:l?Date.now()-l:0})})});else{const i=T(),e=n[i]||{websitesVisited:[],totalTime:0};r({tabData:u,activeDomain:w,timeLimits:h,strictLimits:g,activeTabs:f,dailyData:e,sessionStartTime:l,currentSessionTime:l?Date.now()-l:0})}return!0}else{if(t.type==="CLEAR_DATA")return u={},w=null,D.clear(),m?(b=Date.now(),c=Date.now()):(y=null,b=null),chrome.storage.local.set({tabData:{},activeDomain:null},()=>{r({success:!0})}),o(),!0;if(t.type==="CLEAR_DAILY_DATA"){const i=T();return n[i]?(n[i]={tabData:{},websitesVisited:[],totalTime:0},chrome.storage.local.set({dailyTabData:n},()=>{r({success:!0})})):r({success:!0}),!0}else if(t.type==="SET_TIME_LIMIT"){const{domain:i,limit:e,strict:a}=t;return e?(h[i]=e,a?g[i]=!0:delete g[i]):(delete h[i],delete g[i]),chrome.storage.local.set({timeLimits:h,strictLimits:g},()=>{r({success:!0})}),!0}else if(t.type==="TOGGLE_TRACKING")return m=t.enabled,m?(b=Date.now(),c=Date.now(),l||L(),o()):b=null,chrome.storage.local.set({isTrackingEnabled:m},()=>{r({success:!0,isTrackingEnabled:m})}),!0}});chrome.tabs.onUpdated.addListener((t,s,r)=>{m&&t===y&&s.status&&(b=Date.now(),c=Date.now())});chrome.runtime.onStartup.addListener(()=>{console.log("Browser started - initializing session tracking"),$(),o()});v();A();o();
